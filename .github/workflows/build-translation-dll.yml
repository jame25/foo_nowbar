name: Build Component

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # -------------------------------------------------------------------------
    # 1. Checkout Repositories
    # -------------------------------------------------------------------------
    
    # 1.1 My Project
    - name: Checkout foo_nowbar
      uses: actions/checkout@v4
      with:
        path: foo_nowbar

    # 1.2 Columns UI Component (Wrapper)
    - name: Checkout Columns UI Source
      uses: actions/checkout@v4
      with:
        repository: reupen/columns_ui
        path: columns_ui

    # 1.3 Columns UI SDK (Build target: columns_ui_sdk.lib)
    - name: Checkout Columns UI SDK
      uses: actions/checkout@v4
      with:
        repository: reupen/columns_ui-sdk
        path: columns_ui/columns_ui-sdk

    # 1.4 Foobar2000 SDK (Build target: foobar2000_SDK.lib)
    - name: Checkout Foobar2000 SDK
      uses: actions/checkout@v4
      with:
        repository: reupen/foobar2000-sdk-modified
        path: columns_ui/foobar2000

    # 1.5 PFC (Build target: pfc.lib)
    - name: Checkout PFC
      uses: actions/checkout@v4
      with:
        repository: reupen/pfc-modified
        path: columns_ui/pfc

    # 1.6 libPPUI (Helper)
    - name: Checkout libPPUI
      uses: actions/checkout@v4
      with:
        repository: marc2k3/foobar2000-sdk
        path: temp_libppui
        sparse-checkout: libPPUI
        sparse-checkout-cone-mode: false

    - name: Move libPPUI
      run: |
        move temp_libppui\libPPUI columns_ui\libPPUI
        rmdir /s /q temp_libppui
      shell: cmd

    # 1.7 SVG Services (Header only API)
    - name: Checkout SVG Services
      uses: actions/checkout@v4
      with:
        repository: reupen/svg-services
        path: columns_ui/svg-services

    # -------------------------------------------------------------------------
    # 2. Build Environment Setup
    # -------------------------------------------------------------------------
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # Debug: Verify structure matches project expectations
    - name: Debug Directory Structure
      run: |
        echo "Listing columns_ui structure..."
        dir columns_ui
        dir columns_ui\pfc
        dir columns_ui\foobar2000\SDK
      shell: cmd

    # -------------------------------------------------------------------------
    # 3. Build Dependencies (The Fix for LNK1181)
    # -------------------------------------------------------------------------

    # 3.1 Build PFC
    - name: Build PFC
      run: msbuild columns_ui/pfc/pfc.vcxproj /p:Configuration=Release /p:Platform=x64 /p:OutDir=x64\pfc\

    # 3.2 Build Foobar2000 SDK
    # FORCE OutDir to match what foo_nowbar expects: SDK/x64/foobar2000_SDK/
    - name: Build Foobar2000 SDK
      run: msbuild columns_ui/foobar2000/SDK/foobar2000_SDK.vcxproj /p:Configuration=Release /p:Platform=x64 /p:OutDir=x64\foobar2000_SDK\

    # 3.3 Build Columns UI SDK
    - name: Build Columns UI SDK
      run: msbuild columns_ui/columns_ui-sdk/columns_ui-sdk.vcxproj /p:Configuration=Release /p:Platform=x64 /p:OutDir=x64\columns_ui_sdk\

    # 3.4 Build Shared (Try to find project, or assume built by SDK hooks)
    # Note: If this fails, we may need to build 'foobar2000_component_client' instead.
    - name: Build Shared
      run: |
        if exist columns_ui\foobar2000\shared\shared.vcxproj (
          msbuild columns_ui\foobar2000\shared\shared.vcxproj /p:Configuration=Release /p:Platform=x64
        ) else (
           echo "shared.vcxproj not found, assuming shared.lib is built manually or by other projects."
           # Attempt to build component_client as a fallback to generate shared objs if needed
           if exist columns_ui\foobar2000\foobar2000_component_client\foobar2000_component_client.vcxproj (
             msbuild columns_ui\foobar2000\foobar2000_component_client\foobar2000_component_client.vcxproj /p:Configuration=Release /p:Platform=x64
           )
        )
      shell: cmd

    # -------------------------------------------------------------------------
    # 4. Build Your Component
    # -------------------------------------------------------------------------
    - name: Build foo_nowbar
      # We force OutDir to "..\bin\" (relative to project file) so the DLL lands in the repo root/bin
      run: msbuild foo_nowbar/foo_nowbar.vcxproj /p:Configuration=Release /p:Platform=x64 /p:OutDir=..\bin\

    # Debug: List the bin folder to be sure
    - name: List Output Files
      run: dir bin
      shell: cmd

    - name: Upload DLL
      uses: actions/upload-artifact@v4
      with:
        name: foo_nowbar_dll
        path: bin/foo_nowbar.dll
        if-no-files-found: error
